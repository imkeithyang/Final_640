---
title: "Exploring Difference in Difference Estimator Behavior Under Different Settings"
author: "Zheyuan Liu, Haoming Yang"
date: "4/16/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(tidyr)
```


```{r}
inverse_logit = function(logit) {
  return (exp(logit)/(1+exp(logit)))
}
```

```{r}
# Binary Timepoint
t = c(rep(0,500), rep(1,500), rep(0,500), rep(1,500))
# Binaray Treatment
treatment = c(rep(0,1000), rep(1,1000))
x = c(rnorm(1000, 0, 1), rnorm(1000, 1, 1))

alpha = rnorm(1,0,1)
gamma = rnorm(1,0,1)
delta_t = rnorm(1,1,1)
tau = rnorm(1,3,1)
beta = rnorm(1,0,1)
error = rnorm(length(treatment), 0, 0.1)
logit = alpha + gamma*treatment + delta_t*t + tau*t*treatment + beta*x + error
p = inverse_logit(logit)

# remove tau term, assuming no treatment
error = rnorm(length(treatment), 0, 0.1)
logit_projection = alpha + gamma*treatment + delta_t*t + beta*x + error*t
logit_projection = logit_projection
p_projection = inverse_logit(logit_projection)
```

```{r}
df_logit = data.frame(t = t, treatment = treatment, logit = logit, p = p, 
                logit_projection = logit_projection, p_projection = p_projection)
ggplot(df_logit, aes(x=t, color=factor(treatment))) + 
  geom_line(aes(y=logit)) + 
  geom_line(aes(y=logit_projection), linetype = "dashed")

ggplot(df_logit, aes(x=t, color=factor(treatment))) + 
  geom_line(aes(y=p)) + 
  geom_line(aes(y=p_projection), linetype = "dashed")

```

```{r}
# Binary Timepoint
t = c(rep(0,500), rep(1,500), rep(0,500), rep(1,500))
# Binaray Treatment
treatment = c(rep(0,1000), rep(1,1000))
x = c(rnorm(1000, 5, 1), rnorm(1000, 10, 1))

alpha = rnorm(1,10,1)
gamma = rnorm(1,1,1)
delta_t = rnorm(1,0,1)
tau = rnorm(1,10,1)
beta = rnorm(1,0,1)
error = rnorm(length(treatment), 0, 1)
lambda = log(alpha + gamma*treatment + delta_t*t + tau*t*treatment + beta*x + error)
count = rpois(length(lambda), exp(lambda))

# get projection count via inverse cdf sampling
# remove tau term, assuming no treatment
error = rnorm(length(treatment), 0, 1)
lambda_projection = log(alpha + gamma*treatment + delta_t*t + beta*x + error)
lambda_projection = lambda_projection
count_projection = qpois(ppois(count, exp(lambda)), exp(lambda_projection))
```

```{r}
df_poisson = data.frame(t = t, treatment = treatment, lambda = lambda, count = count, 
                lambda_projection = lambda_projection, count_projection = count_projection)
ggplot(df_poisson, aes(x=t, color=factor(treatment))) + 
  geom_line(aes(y=lambda)) + 
  geom_line(aes(y=lambda_projection), linetype = "dashed")

ggplot(df_poisson, aes(x=t, color=factor(treatment))) + 
  geom_line(aes(y=count)) + 
  geom_line(aes(y=count_projection), linetype = "dashed")
```
# non-parametric
```{r}
DiD = function(Y_before, Y_after, G) {
  treat_after = Y_after[G==1] 
  treat_before = Y_before[G==1] 
  not_treat_after = Y_after[G==0]  
  not_treat_before = Y_before[G==0] 
  
  treated = mean(treat_after) - mean(treat_before)
  not_treated = mean(not_treat_after) - mean(not_treat_before)
  return (treated - not_treated)
}
```


## DiD non parametric
```{r}
ggplot(df_logit, aes(x=logit_projection, color=factor(treatment))) + 
  geom_point(aes(y=logit))

ggplot(df_poisson, aes(x=exp(lambda_projection), color=factor(treatment))) + 
  geom_point(aes(y=exp(lambda)))


DiD(logit_projection, logit, treatment)
DiD(lambda_projection, lambda, treatment)
```



# Card and Kruger's Parallel Trend Assumption 
```{r, warning = FALSE}

dat <- read_table2('public.dat')
codebook <- read_lines(file = "codebook")

# extract variable name
variable_names <- codebook %>%
  `[`(8:59) %>%
  `[`(-c(5, 6, 13, 14, 32, 33)) %>%
  str_sub(1, 13) %>%
  str_squish() %>%
  str_to_lower()


# match with raw data
dat <- dat %>%
  select(-X47) %>%
  `colnames<-`(., variable_names) %>%
  mutate_all(as.numeric) %>%
  mutate(sheet = as.character(sheet))


# compare before and after outcome
dat <- dat %>% 
  group_by(state) %>% 
  mutate(fte=empft+nmgrs+(0.5*emppt),
         fte_after=empft2+nmgrs2+(0.5*emppt2)) 


summary <- dat %>% group_by(state) %>% 
            summarise(mean_before=mean(fte,na.rm=T),
                      mean_after=mean(fte_after,na.rm=T),
                      var_before=var(fte,na.rm=T),
                      var_after=var(fte_after,na.rm=T),
                      count_before=sum(!is.na(fte)),
                      count_after=sum(!is.na(fte_after))) %>%
           ungroup() %>%
           mutate(se_before=sqrt(var_before/count_before),
                  se_after=sqrt(var_after/count_after)) %>%
          mutate(state=ifelse(state==0,"PA","NJ")) 


# treatment and control average unemployment
plot_df <- dat %>%
  group_by(state) %>% 
  summarise(mean_before=mean(fte,na.rm=T),
            mean_after=mean(fte_after,na.rm=T)) %>%
  mutate(state = ifelse(state == 0, "PA", "NJ")) 

# wide to long format 
plot_df_2 <- gather(plot_df, 
                    time, 
                    obs_unemployment, 
                    mean_before:mean_after, 
                    factor_key = TRUE) 

# impute counterfactual unemployment average on the treated 
y_counterfactual = plot_df_2[3,3] - plot_df_2[1, 3] + plot_df_2[2, 3]

plot_df_2 <- plot_df_2 %>%
  mutate(time = ifelse(time == 'mean_before', 0, 1))

plot_df_2$diff_unemploy <- plot_df_2$obs_unemployment
plot_df_2[4, 4] <- y_counterfactual[1,1]


# plot parallel trend asssumption 
ggplot(plot_df_2) +
  geom_line(aes(x = time, y = obs_unemployment, linetype = state)) +
  geom_line(aes(x = time, y = diff_unemploy, linetype = state)) +
  labs(title = "Minimum Wage Observed Effect and Counterfactual Effect on NJ and PA ")



  
```






# Regression Perspective 
```{r}
dat_regression <- gather(dat, 
                    time, 
                    unemployment, 
                    fte:fte_after, 
                    factor_key = TRUE) 

dat_regression <- dat_regression %>%
  mutate(time = ifelse(time == 'fte', 0, 1)) %>%
  select(state, time, unemployment)


# fitting linear regression 
```


